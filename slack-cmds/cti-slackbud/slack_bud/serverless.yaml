# We're excited that this project has provided you enough value that you are looking at its code!
#
# This is a standard [Serverless Framework](https://www.serverless.com) project and you should
# feel welcome to customize it to your needs and delight.
#
# Thanks!

# If the following value is changed, your service may be duplicated (this value is used to build the CloudFormation
# Template script's name)
service: serverless-slackbud
provider: # Using Python 2.7 on AWS
  name: aws
  runtime: python2.7
  region: us-east-1
  deploymentBucket:
    name: cti-lambda-serverless-deploy-bucket # Deployment bucket name. Default is generated by the framework
    serverSideEncryption: AES256 # when using server-side encryption
  iamRoleStatements:
    - Effect: "Allow"
      Action:
       - "lambda:InvokeFunction"
      Resource:
        "Fn::Join":
          - ':'
          -
            - "arn:aws:lambda"
            - Ref: "AWS::Region"
            - Ref: "AWS::AccountId"
            - "function"
            - "${self:service}-${opt:stage, self:provider.stage}-slackBud*" # must match function name
    - Sid: Stmt1456797057000
      Effect: Allow
      Action:
      - sts:AssumeRole
      Resource:
      - "*"
    - Effect: Allow
      Action:
      - iam:GetRole
      - iam:PassRole
      Resource: "*"
    - Effect: Allow
      Action:
      - autoscaling:Describe*
      - cloudfront:List*
      - cloudformation:*
      - dynamodb:*
      - ec2:CreateNetworkInterface
      - ec2:Describe*
      - ec2:StartInstances
      - ec2:StopInstances
      - ec2:CreateTags
      - ec2:DeleteTags
      - ec2:DeleteNetworkInterface
      - ecs:Describe*
      - ecs:List*
      - elasticloadbalancing:Describe*
      - es:*
      - logs:TagLogGroup
      - logs:UntagLogGroup
      - logs:List*
      - logs:Describe*
      - resource-groups:*
      - rds:Describe*
      - s3:*
      - sqs:Tag*
      - sqs:List*
      - sqs:Untag*
      - ssm:Get*
      - ssm:Describe*
      - tag:*
      - ssm:SendCommand
      Resource: "*"
    - Effect: Allow
      Action:
      - "lambda:InvokeFunction"
      Resource:
      - "arn:aws:lambda:us-east-1:123456789012:function:slackbud-longtasks-dev"
      - "arn:aws:lambda:us-east-1:123456789012:function:slackbud-longtasks"
      - "arn:aws:lambda:us-east-1:123456789012:function:cti-ecscli"

functions:
  slackBud:
    handler: ${opt:entryPoint}
    events:
      - http:
          path: slackapi
          method: POST
    timeout: 30
    memorySize: 192  # Options: 128 MB, 192 MB, ...
    environment:
      slackToken: ${opt:slackToken}
    vpc:
      subnetIds:
        - subnet-1124b33c
        #- subnet-7180145c
      securityGroupIds:
        - sg-06c4a9ed84e31cbb3
        #- sg-e178149b
Outputs:
  SlackBudLambdaFunctionQualifiedArn:
    Export:
      Name: ${self:service}-BudLambdaArn